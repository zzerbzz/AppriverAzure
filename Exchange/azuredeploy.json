{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
	"exchangeStorageSizeInGB": {
            "type": "int",
            "defaultValue": 10,
            "metadata": {
                "description": "Exchange Mailbox storage size in GB."
            }
        },
    "vmAdminUsername": {
        "type": "string",
        "metadata": {
            "description": "The name of the administrator account of the new VM and domain"
            }
        },
    "vmAdminPassword": {
        "type": "securestring",
        "metadata": {
            "description": "The password for the administrator account of the new VM and domain"
            }
        },
    "exchangeDomainName": {
            "type": "string",
            "metadata": {
                "description": "Domain Name you want to use."
                }
            }
    },

    "variables": {
        "exchangeVMCount": 1,
        "imagePublisher": "MicrosoftWindowsServer",
        "imageOffer": "WindowsServer",
        "storageAccountType": "Standard_LRS",
        "resourcegroup": "[resourceGroup().name]",
        "uniqueStorageAccountName": "[tolower(concat('sa-', replace(variables('resourceGroup'),'-','')))]",
        "uniqueStorageAccountContainerName": "[tolower(concat('sc-',replace(variables('resourceGroup'),'-','')))]",
        "location": "[resourceGroup().location]",
        "vmOsSku": "2019-Datacenter",
        "vmName": "exdevVM",
        "vmOsDiskName": "[concat('od-', replace(variables('resourceGroup'),'-rg',''))]",
        "vmDataDiskName": "[concat('dd-', replace(variables('resourceGroup'),'-rg',''))]",
        "vmSize": "Standard_D4_v3",
        "vmDataDiskSize": "15",
        "dnsserver": "127.0.0.1",
        "vmNicName": "[tolower(concat('nic-',replace(variables('resourceGroup'),'-rg','')))]",
        "virtualNetworkName": "azeastus-appslab-vnet",
        "virtualNetworkRG": "azeastus-appslab-vnet-rg",
        "virtualNetworkSubnet" : "service-subnet",
        "subnetRef": "[resourceId(variables('virtualNetworkRG'), 'Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworkName'),  variables('virtualNetworkSubnet'))]",
        "modulesPath": "https://raw.githubusercontent.com/zzerbzz/AppriverAzure/master/Exchange/",
        "modulesExchange": "ExchangeWorkload.zip",
        "modulesUrlExchange": "[concat(variables('modulesPath'),variables('modulesExchange'))]",
        "modulesExchangeData": "ExchangeWorkload.psd1",
        "modulesUrlExchangeData": "[concat(variables('modulesPath'),variables('modulesExchangeData'))]",
        "configurationFunctionExchange": "ExchangeWorkload.ps1\\InstallAndConfigureExchange",
        "exchangeInstallerPath": "InstallerExchange",
        "exchangeISOUri": "https://downloadscfa.blob.core.windows.net/downloads/Exchange/ExchangeServer2019-x64-CU2.iso",
        "modulesExchangeISODownload": "CSDownloadISO.ps1",
        "modulesUrlExchangeISODownload": "[concat(variables('modulesPath'),variables('modulesExchangeISODownload'))]"
    },
    "resources": [
        {
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[tolower(variables('uniqueStorageAccountName'))]",
            "location": "[variables('location')]",
            "properties": {
                "accountType": "[variables('storageAccountType')]"
            }
        },
        {
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[variables('VMNicName')]",
            "location": "[variables('location')]",
            "properties": {
                "dnsSettings": {
                    "dnsServers": [ "[variables('dnsserver')]" ]
                },
                "ipConfigurations": [
                {
                    "name": "ipconfig1",
                    "properties": {
                        "privateIPAllocationMethod": "Dynamic",
                        "subnet": {
                        "id": "[variables('subnetRef')]"
                        }
                    }
                }
                ]
            }
        }
    ]
}